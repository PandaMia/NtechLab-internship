# Задание 2

## Описание задачи  

Необходимо обучить нейросеть, способную по входному изображению лица определять пол человека на изображении.

## Описание файлов

- *Gender_recognizer.ipynb* -- notebook-файл с кодом загрузки изображений, а также построения, тренировки и оценки качества нейронной сети
- *model_state-epoch-06-val_acc-0.9584.pth* -- модель обученной нейронной сети
- *process.py* -- скрипт для использования нейросети, с помощью которого можно просчитать переданную через аргументы папку с изображениями 

## Описание решения  
#### Загрузка данных
Для подачи изображений на вход нейронной сети их необходимо преобразовать к единому формату.  
Я привел размеры изображений к формату 100х80, чтобы обучение нейронной сети заняло приемлемое время. 
Преобразование изображений к более высокому разрешению существенно увеличивало время обучения. 
С учётом того, что обучение я осуществлял на CPU, пришлось пожертвовать качеством картинок.  

Далее с помощью функции random_split я разбил датасет на тренировочный, валидационный и тестовый наборы данных для обучения и оценки качества нейронной сети. 
После этого загрузил наборы данных через DataLoader с указанием размера минивыборки, 
а также параметрами последовательной/перемешанной загрузки данных и многопоточности.  

Используемая в задаче метрика качества accuracy может быть не очень показательной в случаях, когда есть сильный перевес по количеству объектов в сторону одного из классов. 
Поэтому полезно убедиться, что объекты исходного набора данных распределены равномерно. 
Для визуализации распределения классов я построил соответствующие гистограммы (см. *Gender_recognizer.ipynb*).  

#### Описание модели  

Выбранная модель имеет 3 сверточных слоя с функциями активации ReLU и 4 линейных слоя также с функциями активации ReLU (кроме последнего слоя, у которого нет функции активации):  
(conv1): Conv2d(3, 32, kernel_size=(3, 3), stride=(1, 1))  
(conv2): Conv2d(32, 64, kernel_size=(3, 3), stride=(1, 1))  
(conv3): Conv2d(64, 128, kernel_size=(3, 3), stride=(1, 1))  
(fc1): Linear(in_features=512, out_features=512, bias=True)  
(fc2): Linear(in_features=512, out_features=256, bias=True)  
(fc3): Linear(in_features=256, out_features=412, bias=True)  
(fc4): Linear(in_features=412, out_features=2, bias=True)  

Кроме того, к каждому сверточному слою применяется слой пуллинга:  
(pool): MaxPool2d(kernel_size=3, stride=3, padding=0, dilation=1, ceil_mode=False)  

Я использую CrossEntropyLoss в качестве функции потерь и оптимизатор Adam с коэффициентом обучения 0.0003.  
Метрикой оценки качества нейронной сети является accuracy.

#### Параметры обучения

Обучение нейросети происходило на 15 эпохах с размером минивыборки: 64 изображения.
В процессе тренировки я сохранял историю обучения для дальнейшей визуализации. 
Кроме этого, каждую эпоху я сохранял состояние нейросети для возможности выбора оптимальной модели, а также на случай переобучения и необходимости отката к более раннему состоянию.

#### Результаты обучнения  

На валидационной выборке нейросеть выдавала не стабильный результат при уверенном снижении функционала ошибки на тренировочных данных. После 8 эпохи ошибка стала заметно увеличиваться, что говорит о переобучении модели. При этом качество работы оставалось на уровне 95 - 96%.  
Время обучения составило 5 часов.

В итоге после 15 эпох обучения модель показала на тестовой выборке качество 96.16% с показателем ошибки 0.1510.  
Модель, имевшая наименьший показатель ошибки на валидации (обучавшаяся 6 эпох), показала качество 95.90% на тесте с показателем ошибки 0.1056. Она же и прилагается в качестве ответа на задание.

## Инструкция для запуска тренировки нейросети  

Запустить тренировку нейросети можно с использованием notebook-файла *Gender_recognizer.ipynb*  
Обучающие данные необходимо разместить в директориях */data/female* и */data/male*

## Инструкция для запуска скрипта *process.py*  

Файл с тестируемой моделью (*model_state-epoch-06-val_acc-0.9584.pth*) должен находиться в одной директории с запускаемым файлом *process.py*

В командной строке ввести команду:  
# *python process.py folder/to/process/*  
# где  

Скрипт сохраняет файл *process_results.json* с информацией о результатах процессинга (в директорию, где находится *process.py*).
